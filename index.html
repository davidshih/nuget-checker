<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NuGet å¥—ä»¶æ¼æ´æª¢æŸ¥å™¨</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ” NuGet å¥—ä»¶æ¼æ´æª¢æŸ¥å™¨</h1>
            <p>æª¢æŸ¥ NuGet å¥—ä»¶çš„å®‰å…¨æ¼æ´ï¼Œæ”¯æ´å¤šå€‹å®‰å…¨è³‡æ–™åº«æŸ¥è©¢</p>
        </header>

        <main>
            <div class="input-section">
                <h2>è¼¸å…¥å¥—ä»¶æ¸…å–®</h2>
                <div class="input-group">
                    <label for="packages">å¥—ä»¶åç¨±ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰ï¼š</label>
                    <textarea 
                        id="packages" 
                        placeholder="ä¾‹å¦‚ï¼šserilog.4.3.0.nupkg, newtonsoft.json.13.0.1.nupkg, microsoft.extensions.logging.2.1.0.nupkg"
                        rows="4"
                    ></textarea>
                </div>
                
                <div class="button-group">
                    <button id="checkBtn" onclick="checkVulnerabilities()">
                        <span id="btnText">ğŸ” é–‹å§‹æª¢æŸ¥</span>
                        <span id="loadingSpinner" class="spinner" style="display: none;">â³ æª¢æŸ¥ä¸­...</span>
                    </button>
                    <button id="clearBtn" onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤çµæœ</button>
                </div>
            </div>

            <div id="results" class="results-section" style="display: none;">
                <h2>æª¢æŸ¥çµæœ</h2>
                <div id="summary" class="summary"></div>
                <div id="vulnerabilities" class="vulnerabilities"></div>
            </div>

            <div id="error" class="error-section" style="display: none;">
                <h3>âŒ éŒ¯èª¤</h3>
                <p id="errorMessage"></p>
            </div>
        </main>

        <footer>
            <div class="info-section">
                <h3>ğŸ“Š æ”¯æ´çš„å®‰å…¨è³‡æ–™åº«</h3>
                <ul>
                    <li><strong>NVD</strong> - National Vulnerability Database (ç¾åœ‹åœ‹å®¶æ¼æ´è³‡æ–™åº«)</li>
                    <li><strong>OSV</strong> - Open Source Vulnerabilities (Google é–‹æºæ¼æ´è³‡æ–™åº«)</li>
                    <li><strong>GitHub Advisory</strong> - GitHub å®‰å…¨å»ºè­°è³‡æ–™åº«</li>
                    <li><strong>Snyk</strong> - Snyk æ¼æ´è³‡æ–™åº«</li>
                </ul>
                
                <h3>ğŸ“ ä½¿ç”¨èªªæ˜</h3>
                <ul>
                    <li>è¼¸å…¥ NuGet å¥—ä»¶åç¨±ï¼Œæ”¯æ´ .nupkg æ ¼å¼</li>
                    <li>å¤šå€‹å¥—ä»¶è«‹ç”¨é€—è™Ÿåˆ†éš”</li>
                    <li>ç³»çµ±æœƒè‡ªå‹•è§£æå¥—ä»¶åç¨±å’Œç‰ˆæœ¬è™Ÿ</li>
                    <li>åªé¡¯ç¤º CVSS åˆ†æ•¸ â‰¥ 4.0 çš„ä¸­é«˜é¢¨éšªæ¼æ´</li>
                    <li>çµæœæŒ‰ CVSS åˆ†æ•¸ç”±é«˜åˆ°ä½æ’åº</li>
                </ul>
            </div>
        </footer>
    </div>

    <script>
        async function checkVulnerabilities() {
            const packagesInput = document.getElementById('packages').value.trim();
            const checkBtn = document.getElementById('checkBtn');
            const btnText = document.getElementById('btnText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const resultsDiv = document.getElementById('results');
            const errorDiv = document.getElementById('error');
            
            // æ¸…é™¤ä¹‹å‰çš„çµæœ
            resultsDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            
            if (!packagesInput) {
                showError('è«‹è¼¸å…¥è‡³å°‘ä¸€å€‹å¥—ä»¶åç¨±');
                return;
            }
            
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            checkBtn.disabled = true;
            btnText.style.display = 'none';
            loadingSpinner.style.display = 'inline';
            
            try {
                const response = await fetch('/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        packages: packagesInput
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayResults(data);
                } else {
                    showError(data.error || 'æª¢æŸ¥å¤±æ•—');
                }
                
            } catch (error) {
                console.error('è«‹æ±‚éŒ¯èª¤:', error);
                showError('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ä¼ºæœå™¨æ˜¯å¦æ­£å¸¸é‹è¡Œ');
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                checkBtn.disabled = false;
                btnText.style.display = 'inline';
                loadingSpinner.style.display = 'none';
            }
        }
        
        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            const summaryDiv = document.getElementById('summary');
            const vulnerabilitiesDiv = document.getElementById('vulnerabilities');
            
            // é¡¯ç¤ºæ‘˜è¦
            summaryDiv.innerHTML = `
                <div class="summary-stats">
                    <div class="stat">
                        <span class="stat-number">${data.total_packages}</span>
                        <span class="stat-label">æª¢æŸ¥å¥—ä»¶</span>
                    </div>
                    <div class="stat">
                        <span class="stat-number">${data.total_vulnerabilities}</span>
                        <span class="stat-label">ç™¼ç¾æ¼æ´</span>
                    </div>
                </div>
            `;
            
            // é¡¯ç¤ºæ¼æ´è©³æƒ…
            if (data.vulnerabilities.length === 0) {
                vulnerabilitiesDiv.innerHTML = `
                    <div class="no-vulnerabilities">
                        <h3>âœ… å¤ªå¥½äº†ï¼</h3>
                        <p>åœ¨æª¢æŸ¥çš„å¥—ä»¶ä¸­æ²’æœ‰ç™¼ç¾ä¸­é«˜é¢¨éšªæ¼æ´ã€‚</p>
                    </div>
                `;
            } else {
                let vulnerabilitiesHtml = '<div class="vulnerabilities-table">';
                vulnerabilitiesHtml += `
                    <div class="table-header">
                        <div class="col-package">å¥—ä»¶</div>
                        <div class="col-cve">CVE ç·¨è™Ÿ</div>
                        <div class="col-score">CVSS åˆ†æ•¸</div>
                        <div class="col-severity">åš´é‡ç¨‹åº¦</div>
                        <div class="col-source">ä¾†æº</div>
                        <div class="col-description">æè¿°</div>
                        <div class="col-link">é€£çµ</div>
                    </div>
                `;
                
                data.vulnerabilities.forEach(vuln => {
                    const severityClass = getSeverityClass(vuln.severity);
                    vulnerabilitiesHtml += `
                        <div class="table-row">
                            <div class="col-package">
                                <strong>${vuln.package}</strong>
                                ${vuln.package_version ? `<br><small>v${vuln.package_version}</small>` : ''}
                            </div>
                            <div class="col-cve">${vuln.cve_id}</div>
                            <div class="col-score">
                                <span class="cvss-score ${severityClass}">${vuln.cvss_score}</span>
                            </div>
                            <div class="col-severity">
                                <span class="severity ${severityClass}">${vuln.severity}</span>
                            </div>
                            <div class="col-source">
                                <span class="source-badge">${vuln.source}</span>
                            </div>
                            <div class="col-description">
                                <div class="description-text">${truncateText(vuln.description, 100)}</div>
                            </div>
                            <div class="col-link">
                                <a href="${vuln.link}" target="_blank" class="link-btn">æŸ¥çœ‹è©³æƒ…</a>
                            </div>
                        </div>
                    `;
                });
                
                vulnerabilitiesHtml += '</div>';
                vulnerabilitiesDiv.innerHTML = vulnerabilitiesHtml;
            }
            
            resultsDiv.style.display = 'block';
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error');
            const errorMessage = document.getElementById('errorMessage');
            
            errorMessage.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        function clearResults() {
            document.getElementById('packages').value = '';
            document.getElementById('results').style.display = 'none';
            document.getElementById('error').style.display = 'none';
        }
        
        function getSeverityClass(severity) {
            switch (severity?.toUpperCase()) {
                case 'CRITICAL': return 'critical';
                case 'HIGH': return 'high';
                case 'MEDIUM': return 'medium';
                case 'LOW': return 'low';
                default: return 'unknown';
            }
        }
        
        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }
        
        // æ”¯æ´ Enter éµæäº¤
        document.getElementById('packages').addEventListener('keydown', function(event) {
            if (event.ctrlKey && event.key === 'Enter') {
                checkVulnerabilities();
            }
        });
    </script>
</body>
</html>
